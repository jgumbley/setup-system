---
- name: Add LazyGit snapshot PPA
  apt_repository:
    repo: ppa:roguescholar/snapshots
    state: present
    update_cache: yes
  become: yes

- name: Ensure APT keyrings directory exists
  file:
    path: /etc/apt/keyrings
    state: directory
    mode: '0755'
  become: yes

- name: Download NodeSource GPG key (ASCII armored)
  get_url:
    url: https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key
    dest: /etc/apt/keyrings/nodesource.gpg.key
    mode: '0644'
  become: yes

- name: Convert NodeSource GPG key to keyring (dearmor)
  command: >-
    gpg --dearmor -o /etc/apt/keyrings/nodesource.gpg /etc/apt/keyrings/nodesource.gpg.key
  args:
    creates: /etc/apt/keyrings/nodesource.gpg
  become: yes

- name: Add NodeSource Node.js 22.x repository (signed-by)
  apt_repository:
    repo: >-
      deb [arch={{ 'amd64' if ansible_architecture in ['x86_64','amd64'] else 'arm64' }}
      signed-by=/etc/apt/keyrings/nodesource.gpg]
      https://deb.nodesource.com/node_22.x nodistro main
    state: present
    update_cache: yes
  become: yes

- name: Install Node.js (includes npm)
  apt:
    name: nodejs
    state: latest
  become: yes

- name: Verify Node.js major version is 22
  command: node --version
  register: node_version
  changed_when: false
  failed_when: node_version.stdout is not match("^v22\\.")

- name: Install core packages with apt
  apt:
    name: "{{ item }}"
    state: present
    update_cache: yes
    cache_valid_time: 3600
  become: yes
  loop: "{{ core_packages }}"

- name: Ensure cowsay is not installed
  apt:
    name: cowsay
    state: absent
  become: yes

- name: Add fish shell to /etc/shells
  lineinfile:
    path: /etc/shells
    line: /usr/bin/fish
    state: present
  become: yes

- name: Install uv with pipx
  shell: pipx install uv
  args:
    creates: "~/.local/bin/uv"

- name: Test uv installation
  shell: ~/.local/bin/uv --version
  register: uv_version
  changed_when: false

- name: Initialize rustup with stable toolchain
  shell: rustup default stable
  args:
    creates: "{{ ansible_env.HOME }}/.rustup"
  changed_when: false
