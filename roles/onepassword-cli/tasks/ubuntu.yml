---
- name: Remove conflicting 1Password source entries with legacy keyring path
  shell: |
    set -euo pipefail
    for list_file in /etc/apt/sources.list /etc/apt/sources.list.d/*.list; do
      [ -e "$list_file" ] || continue
      if grep -q "downloads.1password.com" "$list_file"; then
        sed -i '\#/etc/apt/keyrings/1password-archive-keyring.gpg#d' "$list_file"
      fi
    done
  args:
    executable: /bin/bash
  become: yes

- name: Download 1Password GPG key (ASCII armored)
  get_url:
    url: https://downloads.1password.com/linux/keys/1password.asc
    dest: /usr/share/keyrings/1password.asc
    mode: '0644'
  become: yes

- name: Convert 1Password GPG key to keyring (dearmor)
  command: >-
    gpg --dearmor -o /usr/share/keyrings/1password-archive-keyring.gpg /usr/share/keyrings/1password.asc
  args:
    creates: /usr/share/keyrings/1password-archive-keyring.gpg
  become: yes

- name: Add 1Password CLI repository (signed-by)
  apt_repository:
    repo: >-
      deb [arch={{ 'amd64' if ansible_architecture in ['x86_64','amd64'] else 'arm64' }}
      signed-by=/usr/share/keyrings/1password-archive-keyring.gpg]
      https://downloads.1password.com/linux/debian/{{ 'amd64' if ansible_architecture in ['x86_64','amd64'] else 'arm64' }}
      stable main
    state: present
    update_cache: yes
  become: yes

- name: Install 1Password CLI
  apt:
    name: 1password-cli
    state: present
  become: yes
