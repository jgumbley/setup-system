---
# Powersave role: reduce background services, prefer native power-profiles-daemon,
# install powertop, keep logs efficient.
# Safe for Ubuntu/Debian; avoids touching rpcbind (needed for NFSv3).

- name: Ensure facts are gathered
  setup:
  when: ansible_facts is not defined

- name: Proceed only on Debian/Ubuntu families
  assert:
    that:
      - ansible_os_family == 'Debian'
    fail_msg: "powersave role currently supports Debian/Ubuntu only"

# --- Package adjustments ---

- name: Install power saving tools (power-profiles-daemon, powertop)
  apt:
    name:
      - power-profiles-daemon
      - powertop
    state: present
    update_cache: yes

- name: Add Mozilla Team PPA for Firefox (deb version)
  apt_repository:
    repo: ppa:mozillateam/ppa
    state: present
    filename: mozillateam-ppa

- name: Pin Firefox to mozillateam PPA
  copy:
    dest: /etc/apt/preferences.d/mozillateam-firefox
    content: |
      Package: firefox*
      Pin: release o=LP-PPA-mozillateam
      Pin-Priority: 1001
    owner: root
    group: root
    mode: '0644'

- name: Install Firefox (deb) from PPA
  apt:
    name: firefox
    state: present
    update_cache: yes
    allow_downgrades: yes

- name: Remove Snap daemon (snapd) with allow-downgrades
  command: apt-get -y --allow-downgrades remove snapd
  environment:
    DEBIAN_FRONTEND: noninteractive
  register: snapd_remove
  changed_when: "'not installed' not in snapd_remove.stdout"
  failed_when: snapd_remove.rc not in [0]

- name: Remove Ubuntu Advantage tools (unused)
  apt:
    name: ubuntu-advantage-tools
    state: absent
  register: ua_pkg_removed
  failed_when: false

- name: Remove CUPS server packages (no printing needed)
  apt:
    name:
      - cups
      - cups-browsed
      - cups-daemon
      - cups-common
      - cups-client
      - printer-driver-all
    state: absent
  register: cups_removed
  failed_when: false

# --- Service tweaks ---

- name: Enable and start power-profiles-daemon (native scheduler)
  systemd:
    name: power-profiles-daemon.service
    enabled: yes
    state: started
  failed_when: false

- name: Set system to power-saver profile
  command: powerprofilesctl set power-saver
  register: ppd_set
  changed_when: ppd_set.rc == 0
  failed_when: false




  

- name: Disable and stop Bluetooth
  systemd:
    name: bluetooth.service
    enabled: no
    state: stopped
  failed_when: false

- name: Disable and stop Avahi (mDNS)
  systemd:
    name: avahi-daemon.service
    enabled: no
    state: stopped
  failed_when: false

- name: Stop Avahi socket
  systemd:
    name: avahi-daemon.socket
    enabled: no
    state: stopped
  failed_when: false

- name: Disable and stop ModemManager
  systemd:
    name: ModemManager.service
    enabled: no
    state: stopped
  failed_when: false

- name: Disable and stop GNOME Remote Desktop
  systemd:
    name: gnome-remote-desktop.service
    enabled: no
    state: stopped
  failed_when: false

- name: Enable and start rsyslog
  systemd:
    name: rsyslog.service
    enabled: yes
    state: started
  failed_when: false

- name: Remove journald persistent storage directory if created by role
  file:
    path: /var/log/journal
    state: absent
  failed_when: false

- name: Ensure journald drop-in config directory exists
  file:
    path: /etc/systemd/journald.conf.d
    state: directory
    mode: '0755'

- name: Remove journald persistent config if present
  file:
    path: /etc/systemd/journald.conf.d/99-persistent.conf
    state: absent

- name: Remove journald volatile drop-in if present
  file:
    path: /etc/systemd/journald.conf.d/99-volatile.conf
    state: absent
  failed_when: false

- name: Restart systemd-journald to apply config
  systemd:
    name: systemd-journald.service
    state: restarted

- name: Mask colord service (prevent D-Bus activation)
  systemd:
    name: colord.service
    masked: yes
    state: stopped
  failed_when: false

- name: Disable and stop SSSD
  systemd:
    name: sssd.service
    enabled: no
    state: stopped
  failed_when: false

- name: Disable and stop switcheroo-control (dual GPU helper)
  systemd:
    name: switcheroo-control.service
    enabled: no
    state: stopped
  failed_when: false

- name: Disable and stop fwupd service
  systemd:
    name: fwupd.service
    enabled: no
    state: stopped
    masked: yes
  failed_when: false

- name: Disable fwupd refresh timer
  systemd:
    name: fwupd-refresh.timer
    enabled: no
    state: stopped
  failed_when: false

- name: Disable sysstat timers (reduce periodic wakeups)
  systemd:
    name: "{{ item }}"
    enabled: no
    state: stopped
  loop:
    - sysstat-collect.timer
    - sysstat-summary.timer
  failed_when: false

- name: Disable NetworkManager-wait-online (faster boot)
  systemd:
    name: NetworkManager-wait-online.service
    enabled: no
    state: stopped
  failed_when: false

- name: Disable and stop Ubuntu Advantage service/timer
  systemd:
    name: "{{ item }}"
    enabled: no
    state: stopped
  loop:
    - ubuntu-advantage.service
    - ua-timer.timer
  failed_when: false

# Keep rpcbind enabled due to NFSv3 usage.

- name: Disable OpenVPN service if present
  systemd:
    name: openvpn.service
    enabled: no
    state: stopped
  failed_when: false

- name: Disable OpenVPN client/server template units if present
  systemd:
    name: "{{ item }}"
    enabled: no
    state: stopped
  loop:
    - openvpn-client@.service
    - openvpn-server@.service
  failed_when: false
